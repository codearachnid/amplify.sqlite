/**
 * amplify.sqlite
 * 
 * Enable AmplifyJS requests cache using SQLite storage
 * @version 1.0.1
 * @author Timothy Wood @codearachnid
 * @license GPL v3.0 Copyright Â© 2014, Timothy Wood & Imagine Simplicity
 */
amplify.sqlite=function(){function f(){var b=$.Deferred();return d.expiration=Date.now(),g(a.sprintf(e.EXPIRED,d)).done(function(a){b.resolve(a)}),b.promise()}function g(a){var c=$.Deferred(),e={message:"",code:200,sql:a};return null==b&&(b=window.openDatabase(d.db.name,d.db.version,d.db.display,d.db.size,i),i()),null!==b?b.transaction(function(b){b.executeSql(a,[],function(b,d){c.resolve(d,a,b)},function(a){e.message=a.message,e.code=a.code,c.reject(e)})},function(a){e.message=a.message,e.code=a.code,c.reject(e)}):(e.message="No environment found",e.code=501,c.reject(e)),c.promise()}function h(a){return{key:a.key,data:m(a.data),expiration:Number(a.expiration)}}function i(){g(a.sprintf(e.CREATE,d)).done(function(){f()})}function j(a){var b,c,d,e,f=[b,null,!1,0,"","0"];for(d=0,e=f.length;e>d;d++)if(a===f[d])return!0;if("object"==typeof a){for(c in a)return!1;return!0}return!1}function l(a){return a=JSON.stringify(a),a.replace(/'/g,"&#39;")}function m(a){return JSON.parse(a.replace("&#39;","'"))}function n(a){return Object.prototype.toString.call(a).slice(8,-1).toLowerCase()}function o(a,b){for(var c=[];b>0;c[--b]=a);return c.join("")}var a=this,b=null,c="object"==typeof amplify.sqlite.configuration?amplify.sqlite.configuration:{},d=$.extend({expiration:Date.now(),db:{name:"amplifyStore.db",version:"1.0",display:"Amplify Storage",size:2e4},table:{store:"amplify_store"}},c),e={DROP:" DROP TABLE IF EXISTS %(table.store)s ",CREATE:" CREATE TABLE IF NOT EXISTS %(table.store)s( key VARCHAR(100), data BLOB, expiration INTEGER ) ",INSERT:" INSERT INTO %(table.store)s VALUES( '%(storage.key)s', '%(storage.data)s', %(storage.expiration)d ) ",UPDATE:" UPDATE %(table.store)s SET data ='%(storage.data)s', expiration = %(storage.expiration)d WHERE key = '%(storage.key)s' ",EXPIRED:" DELETE FROM %(table.store)s WHERE expiration < %(expiration)d AND expiration > 0 ",DELETE:" DELETE FROM %(table.store)s WHERE key = '%(storage.key)s' ",SELECT:" SELECT * FROM %(table.store)s WHERE key = '%(storage.key)s' "};a.instance=function(){return this},a.get=function(b){var c=$.Deferred(),f={message:"",code:200,key:b};j(b)&&(f.message="Key must be supplied to retrieve results.",f.code=400,c.reject(f));var i=$.extend({},d,{storage:{key:b}});return g(a.sprintf(e.SELECT,i)).done(function(a){var d="";if(a.rows.length>0){var e=h(a.rows.item(0));(e.expiration>Date.now()||0==e.expiration)&&(d=e.data)}""!=d?c.resolve(d):(f.message="No data found.",f.code=404,c.reject(f))}).fail(function(a){c.reject(a)}),c.promise()},a.put=function(b,c,h){h=h||0;var i=$.Deferred();(j(b)||j(c))&&(error.message="Key and data must be supplied to retrieve results.",error.code=400,i.reject(error)),c="undefined"==typeof c?"":c;var k=$.extend({},d,{storage:{key:b,data:l(c),expiration:h}});return f().done(function(){a.get(b).done(function(){g(a.sprintf(e.UPDATE,k)).done(function(a,b){i.resolve(a,b)})}).fail(function(b){404==b.code?g(a.sprintf(e.INSERT,k)).done(function(a,b){i.resolve(a,b)}):i.reject(b)})}),i.promise()},a.delete=function(b){var c=$.Deferred(),f={message:"",code:200,key:b};j(b)&&(f.message="Key must be supplied to delete stored items.",f.code=400,c.reject(f));var h=$.extend({},d,{storage:{key:b}});return g(a.sprintf(e.DELETE,h)).done(function(a,b){c.resolve(a,b)}).fail(function(a){c.reject(a)}),c.promise()},a.sprintf=function(){return a.sprintf.cache.hasOwnProperty(arguments[0])||(a.sprintf.cache[arguments[0]]=a.sprintf.parse(arguments[0])),a.sprintf.format.call(null,a.sprintf.cache[arguments[0]],arguments)},a.sprintf.format=function(b,c){var g,i,j,k,l,m,p,d=1,e=b.length,f="",h=[];for(i=0;e>i;i++)if(f=n(b[i]),"string"===f)h.push(b[i]);else if("array"===f){if(k=b[i],k[2])for(g=c[d],j=0;j<k[2].length;j++){if(!g.hasOwnProperty(k[2][j]))throw a.sprintf('utils.sprintf property "%s" does not exist',k[2][j]);g=g[k[2][j]]}else g=k[1]?c[k[1]]:c[d++];if(/[^s]/.test(k[8])&&"number"!=n(g))throw a.sprintf("utils.sprintf expecting number but found %s",n(g));switch(k[8]){case"b":g=g.toString(2);break;case"c":g=String.fromCharCode(g);break;case"d":g=parseInt(g,10);break;case"e":g=k[7]?g.toExponential(k[7]):g.toExponential();break;case"f":g=k[7]?parseFloat(g).toFixed(k[7]):parseFloat(g);break;case"o":g=g.toString(8);break;case"s":g=(g=String(g))&&k[7]?g.substring(0,k[7]):g;break;case"u":g>>>=0;break;case"x":g=g.toString(16);break;case"X":g=g.toString(16).toUpperCase()}g=/[def]/.test(k[8])&&k[3]&&g>=0?"+"+g:g,m=k[4]?"0"==k[4]?"0":k[4].charAt(1):" ",p=k[6]-String(g).length,l=k[6]?o(m,p):"",h.push(k[5]?g+l:l+g)}return h.join("")},a.sprintf.cache={},a.sprintf.parse=function(a){for(var b=a,c=[],d=[],e=0;b;){if(null!==(c=/^[^\x25]+/.exec(b)))d.push(c[0]);else if(null!==(c=/^\x25{2}/.exec(b)))d.push("%");else{if(null===(c=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(b)))throw"utils.sprintf incorrectly matched or no targets found.";if(c[2]){e|=1;var f=[],g=c[2],h=[];if(null===(h=/^([a-z_][a-z_\d]*)/i.exec(g)))throw"utils.sprintf incorrectly matched or no targets found.";for(f.push(h[1]);""!==(g=g.substring(h[0].length));)if(null!==(h=/^\.([a-z_][a-z_\d]*)/i.exec(g)))f.push(h[1]);else{if(null===(h=/^\[(\d+)\]/.exec(g)))throw"utils.sprintf incorrectly matched or no targets found.";f.push(h[1])}c[2]=f}else e|=2;if(3===e)throw"utils.sprintf incorrectly mixing positional and named placeholders is not (yet) supported.";d.push(c)}b=b.substring(c[0].length)}return d}},amplify.sqlite.instance=new amplify.sqlite,amplify.request.cache.sqlite=function(a,b,c,d){var e=amplify.request.cache._key(b.resourceId,c.cacheURL(),c.data);if("object"!=typeof b||!b.hasOwnProperty("getRemote")||1!=b.getRemote)return amplify.sqlite.instance.get(e).done(function(a){"object"==typeof a&&(a.fromCache=!0),d.success(a)}).fail(function(){b.getRemote=!0,amplify.request(b)}),!1;var f=d.success;d.success=function(b){var d="object"==typeof a.cache?Number(a.cache.expires)+Date.now():0;amplify.sqlite.instance.put(e,b,d).done(function(){"object"==typeof a.cache&&"number"==typeof a.cache.expires&&a.cache.expires>0&&setTimeout(function(){amplify.sqlite.instance.delete(e)},Number(a.cache.expires))}),f.apply(this,arguments)}};
